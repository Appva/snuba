#!/usr/bin/env python

import json

from kafka import KafkaConsumer, KafkaProducer

from snuba import settings
from snuba.processor import SnubaProcessor


def run():
    consumer = KafkaConsumer(
        settings.RAW_EVENTS_TOPIC,
        bootstrap_servers=settings.BROKERS,
        group_id=settings.PROCESSOR_CONSUMER_GROUP,
    )

    producer = KafkaProducer(
        bootstrap_servers=settings.BROKERS,
        linger_ms=50,
    )

    processor = SnubaProcessor(producer=producer)
    for msg in consumer:
        processor.process_event(json.loads(msg.value))


if __name__ == '__main__':
    run()
