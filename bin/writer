#!/usr/bin/env python

import atexit
import json

import click
from clickhouse_driver import Client
from kafka import KafkaConsumer

from snuba import settings
from snuba.writer import SnubaWriter


@click.command()
@click.option('--processed-events-topic', default=settings.WRITER_TOPIC,
              help='Topic to consume processed events from.')
@click.option('--consumer-group', default=settings.WRITER_CONSUMER_GROUP,
              help='Consumer group used for consuming the processed events topic.')
@click.option('--bootstrap-server', default=settings.BROKERS, multiple=True,
              help='Kafka bootstrap server to use (multiple allowed).')
@click.option('--clickhouse-server', default=settings.CLICKHOUSE_NODES, multiple=True,
              help='Clickhouse server to write to (multiple allowed).')
def run(processed_events_topic, consumer_group, bootstrap_server, clickhouse_server):
    connections = [Client(node) for node in clickhouse_server]

    # ensure tables exist
    for conn in connections:
        conn.execute(settings.LOCAL_TABLE_DEFINITION)
        conn.execute(settings.DIST_TABLE_DEFINITION)

    consumer = KafkaConsumer(
        processed_events_topic,
        bootstrap_servers=bootstrap_server,
        group_id=consumer_group,
    )

    writer = SnubaWriter(connections=connections)

    def exit_handler():
        writer.flush()

    atexit.register(exit_handler)

    for msg in consumer:
        writer.write(json.loads(msg.value))


if __name__ == '__main__':
    run()
